"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TrackedWeakSet = exports.TrackedSet = void 0;
const ember_tracked_storage_polyfill_1 = require("ember-tracked-storage-polyfill");
class TrackedSet {
    constructor(existing) {
        this.collection = (0, ember_tracked_storage_polyfill_1.createStorage)(null, () => false);
        this.storages = new Map();
        this.vals = new Set(existing);
    }
    storageFor(key) {
        const storages = this.storages;
        let storage = storages.get(key);
        if (storage === undefined) {
            storage = (0, ember_tracked_storage_polyfill_1.createStorage)(null, () => false);
            storages.set(key, storage);
        }
        return storage;
    }
    dirtyStorageFor(key) {
        const storage = this.storages.get(key);
        if (storage) {
            (0, ember_tracked_storage_polyfill_1.setValue)(storage, null);
        }
    }
    // **** KEY GETTERS ****
    has(value) {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.storageFor(value));
        return this.vals.has(value);
    }
    // **** ALL GETTERS ****
    entries() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.entries();
    }
    keys() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.keys();
    }
    values() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.values();
    }
    forEach(fn) {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        this.vals.forEach(fn);
    }
    get size() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.size;
    }
    [Symbol.iterator]() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals[Symbol.iterator]();
    }
    get [Symbol.toStringTag]() {
        return this.vals[Symbol.toStringTag];
    }
    // **** KEY SETTERS ****
    add(value) {
        this.dirtyStorageFor(value);
        (0, ember_tracked_storage_polyfill_1.setValue)(this.collection, null);
        this.vals.add(value);
        return this;
    }
    delete(value) {
        this.dirtyStorageFor(value);
        (0, ember_tracked_storage_polyfill_1.setValue)(this.collection, null);
        return this.vals.delete(value);
    }
    // **** ALL SETTERS ****
    clear() {
        this.storages.forEach((s) => (0, ember_tracked_storage_polyfill_1.setValue)(s, null));
        (0, ember_tracked_storage_polyfill_1.setValue)(this.collection, null);
        this.vals.clear();
    }
}
exports.TrackedSet = TrackedSet;
// So instanceof works
Object.setPrototypeOf(TrackedSet.prototype, Set.prototype);
class TrackedWeakSet {
    constructor(values) {
        this.storages = new WeakMap();
        this.vals = new WeakSet(values);
    }
    storageFor(key) {
        const storages = this.storages;
        let storage = storages.get(key);
        if (storage === undefined) {
            storage = (0, ember_tracked_storage_polyfill_1.createStorage)(null, () => false);
            storages.set(key, storage);
        }
        return storage;
    }
    dirtyStorageFor(key) {
        const storage = this.storages.get(key);
        if (storage) {
            (0, ember_tracked_storage_polyfill_1.setValue)(storage, null);
        }
    }
    has(value) {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.storageFor(value));
        return this.vals.has(value);
    }
    add(value) {
        // Add to vals first to get better error message
        this.vals.add(value);
        this.dirtyStorageFor(value);
        return this;
    }
    delete(value) {
        this.dirtyStorageFor(value);
        return this.vals.delete(value);
    }
    get [Symbol.toStringTag]() {
        return this.vals[Symbol.toStringTag];
    }
}
exports.TrackedWeakSet = TrackedWeakSet;
// So instanceof works
Object.setPrototypeOf(TrackedWeakSet.prototype, WeakSet.prototype);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjLy1wcml2YXRlL3NldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtRkFLd0M7QUFFeEMsTUFBYSxVQUFVO0lBOEJyQixZQUFZLFFBQXdEO1FBN0I1RCxlQUFVLEdBQUcsSUFBQSw4Q0FBYSxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU5QyxhQUFRLEdBQWlDLElBQUksR0FBRyxFQUFFLENBQUM7UUE0QnpELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQXpCTyxVQUFVLENBQUMsR0FBTTtRQUN2QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQy9CLElBQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFaEMsSUFBSSxPQUFPLEtBQUssU0FBUyxFQUFFO1lBQ3pCLE9BQU8sR0FBRyxJQUFBLDhDQUFhLEVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzVCO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVPLGVBQWUsQ0FBQyxHQUFNO1FBQzVCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXZDLElBQUksT0FBTyxFQUFFO1lBQ1gsSUFBQSx5Q0FBUSxFQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN6QjtJQUNILENBQUM7SUFTRCx3QkFBd0I7SUFDeEIsR0FBRyxDQUFDLEtBQVE7UUFDVixJQUFBLHlDQUFRLEVBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRWpDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELHdCQUF3QjtJQUN4QixPQUFPO1FBQ0wsSUFBQSx5Q0FBUSxFQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUxQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUk7UUFDRixJQUFBLHlDQUFRLEVBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTFCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsTUFBTTtRQUNKLElBQUEseUNBQVEsRUFBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFMUIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRCxPQUFPLENBQUMsRUFBK0M7UUFDckQsSUFBQSx5Q0FBUSxFQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUxQixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBSSxJQUFJO1FBQ04sSUFBQSx5Q0FBUSxFQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUxQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDZixJQUFBLHlDQUFRLEVBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTFCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFDdEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsd0JBQXdCO0lBQ3hCLEdBQUcsQ0FBQyxLQUFRO1FBQ1YsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QixJQUFBLHlDQUFRLEVBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVyQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBUTtRQUNiLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUIsSUFBQSx5Q0FBUSxFQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFaEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsd0JBQXdCO0lBQ3hCLEtBQUs7UUFDSCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBQSx5Q0FBUSxFQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2hELElBQUEseUNBQVEsRUFBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRWhDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBMUdELGdDQTBHQztBQUVELHNCQUFzQjtBQUN0QixNQUFNLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRTNELE1BQWEsY0FBYztJQXlCekIsWUFBWSxNQUE0QjtRQXhCaEMsYUFBUSxHQUFxQyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBeUJqRSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUF0Qk8sVUFBVSxDQUFDLEdBQU07UUFDdkIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMvQixJQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWhDLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtZQUN6QixPQUFPLEdBQUcsSUFBQSw4Q0FBYSxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM1QjtRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFTyxlQUFlLENBQUMsR0FBTTtRQUM1QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUV2QyxJQUFJLE9BQU8sRUFBRTtZQUNYLElBQUEseUNBQVEsRUFBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDekI7SUFDSCxDQUFDO0lBTUQsR0FBRyxDQUFDLEtBQVE7UUFDVixJQUFBLHlDQUFRLEVBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRWpDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELEdBQUcsQ0FBQyxLQUFRO1FBQ1YsZ0RBQWdEO1FBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXJCLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFNUIsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQVE7UUFDYixJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTVCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDdkMsQ0FBQztDQUNGO0FBckRELHdDQXFEQztBQUVELHNCQUFzQjtBQUN0QixNQUFNLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgVHJhY2tlZFN0b3JhZ2UsXG4gIGNyZWF0ZVN0b3JhZ2UsXG4gIGdldFZhbHVlLFxuICBzZXRWYWx1ZSxcbn0gZnJvbSAnZW1iZXItdHJhY2tlZC1zdG9yYWdlLXBvbHlmaWxsJztcblxuZXhwb3J0IGNsYXNzIFRyYWNrZWRTZXQ8VCA9IHVua25vd24+IGltcGxlbWVudHMgU2V0PFQ+IHtcbiAgcHJpdmF0ZSBjb2xsZWN0aW9uID0gY3JlYXRlU3RvcmFnZShudWxsLCAoKSA9PiBmYWxzZSk7XG5cbiAgcHJpdmF0ZSBzdG9yYWdlczogTWFwPFQsIFRyYWNrZWRTdG9yYWdlPG51bGw+PiA9IG5ldyBNYXAoKTtcblxuICBwcml2YXRlIHZhbHM6IFNldDxUPjtcblxuICBwcml2YXRlIHN0b3JhZ2VGb3Ioa2V5OiBUKTogVHJhY2tlZFN0b3JhZ2U8bnVsbD4ge1xuICAgIGNvbnN0IHN0b3JhZ2VzID0gdGhpcy5zdG9yYWdlcztcbiAgICBsZXQgc3RvcmFnZSA9IHN0b3JhZ2VzLmdldChrZXkpO1xuXG4gICAgaWYgKHN0b3JhZ2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgc3RvcmFnZSA9IGNyZWF0ZVN0b3JhZ2UobnVsbCwgKCkgPT4gZmFsc2UpO1xuICAgICAgc3RvcmFnZXMuc2V0KGtleSwgc3RvcmFnZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0b3JhZ2U7XG4gIH1cblxuICBwcml2YXRlIGRpcnR5U3RvcmFnZUZvcihrZXk6IFQpOiB2b2lkIHtcbiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5zdG9yYWdlcy5nZXQoa2V5KTtcblxuICAgIGlmIChzdG9yYWdlKSB7XG4gICAgICBzZXRWYWx1ZShzdG9yYWdlLCBudWxsKTtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3RvcigpO1xuICBjb25zdHJ1Y3Rvcih2YWx1ZXM6IHJlYWRvbmx5IFRbXSB8IG51bGwpO1xuICBjb25zdHJ1Y3RvcihpdGVyYWJsZTogSXRlcmFibGU8VD4pO1xuICBjb25zdHJ1Y3RvcihleGlzdGluZz86IHJlYWRvbmx5IFRbXSB8IEl0ZXJhYmxlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICAgIHRoaXMudmFscyA9IG5ldyBTZXQoZXhpc3RpbmcpO1xuICB9XG5cbiAgLy8gKioqKiBLRVkgR0VUVEVSUyAqKioqXG4gIGhhcyh2YWx1ZTogVCk6IGJvb2xlYW4ge1xuICAgIGdldFZhbHVlKHRoaXMuc3RvcmFnZUZvcih2YWx1ZSkpO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5oYXModmFsdWUpO1xuICB9XG5cbiAgLy8gKioqKiBBTEwgR0VUVEVSUyAqKioqXG4gIGVudHJpZXMoKTogSXRlcmFibGVJdGVyYXRvcjxbVCwgVF0+IHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5lbnRyaWVzKCk7XG4gIH1cblxuICBrZXlzKCk6IEl0ZXJhYmxlSXRlcmF0b3I8VD4ge1xuICAgIGdldFZhbHVlKHRoaXMuY29sbGVjdGlvbik7XG5cbiAgICByZXR1cm4gdGhpcy52YWxzLmtleXMoKTtcbiAgfVxuXG4gIHZhbHVlcygpOiBJdGVyYWJsZUl0ZXJhdG9yPFQ+IHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy52YWx1ZXMoKTtcbiAgfVxuXG4gIGZvckVhY2goZm46ICh2YWx1ZTE6IFQsIHZhbHVlMjogVCwgc2V0OiBTZXQ8VD4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgdGhpcy52YWxzLmZvckVhY2goZm4pO1xuICB9XG5cbiAgZ2V0IHNpemUoKTogbnVtYmVyIHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5zaXplO1xuICB9XG5cbiAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxUPiB7XG4gICAgZ2V0VmFsdWUodGhpcy5jb2xsZWN0aW9uKTtcblxuICAgIHJldHVybiB0aGlzLnZhbHNbU3ltYm9sLml0ZXJhdG9yXSgpO1xuICB9XG5cbiAgZ2V0IFtTeW1ib2wudG9TdHJpbmdUYWddKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMudmFsc1tTeW1ib2wudG9TdHJpbmdUYWddO1xuICB9XG5cbiAgLy8gKioqKiBLRVkgU0VUVEVSUyAqKioqXG4gIGFkZCh2YWx1ZTogVCk6IHRoaXMge1xuICAgIHRoaXMuZGlydHlTdG9yYWdlRm9yKHZhbHVlKTtcbiAgICBzZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24sIG51bGwpO1xuXG4gICAgdGhpcy52YWxzLmFkZCh2YWx1ZSk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGRlbGV0ZSh2YWx1ZTogVCk6IGJvb2xlYW4ge1xuICAgIHRoaXMuZGlydHlTdG9yYWdlRm9yKHZhbHVlKTtcbiAgICBzZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24sIG51bGwpO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5kZWxldGUodmFsdWUpO1xuICB9XG5cbiAgLy8gKioqKiBBTEwgU0VUVEVSUyAqKioqXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcmFnZXMuZm9yRWFjaCgocykgPT4gc2V0VmFsdWUocywgbnVsbCkpO1xuICAgIHNldFZhbHVlKHRoaXMuY29sbGVjdGlvbiwgbnVsbCk7XG5cbiAgICB0aGlzLnZhbHMuY2xlYXIoKTtcbiAgfVxufVxuXG4vLyBTbyBpbnN0YW5jZW9mIHdvcmtzXG5PYmplY3Quc2V0UHJvdG90eXBlT2YoVHJhY2tlZFNldC5wcm90b3R5cGUsIFNldC5wcm90b3R5cGUpO1xuXG5leHBvcnQgY2xhc3MgVHJhY2tlZFdlYWtTZXQ8VCBleHRlbmRzIG9iamVjdCA9IG9iamVjdD4gaW1wbGVtZW50cyBXZWFrU2V0PFQ+IHtcbiAgcHJpdmF0ZSBzdG9yYWdlczogV2Vha01hcDxULCBUcmFja2VkU3RvcmFnZTxudWxsPj4gPSBuZXcgV2Vha01hcCgpO1xuXG4gIHByaXZhdGUgdmFsczogV2Vha1NldDxUPjtcblxuICBwcml2YXRlIHN0b3JhZ2VGb3Ioa2V5OiBUKTogVHJhY2tlZFN0b3JhZ2U8bnVsbD4ge1xuICAgIGNvbnN0IHN0b3JhZ2VzID0gdGhpcy5zdG9yYWdlcztcbiAgICBsZXQgc3RvcmFnZSA9IHN0b3JhZ2VzLmdldChrZXkpO1xuXG4gICAgaWYgKHN0b3JhZ2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgc3RvcmFnZSA9IGNyZWF0ZVN0b3JhZ2UobnVsbCwgKCkgPT4gZmFsc2UpO1xuICAgICAgc3RvcmFnZXMuc2V0KGtleSwgc3RvcmFnZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0b3JhZ2U7XG4gIH1cblxuICBwcml2YXRlIGRpcnR5U3RvcmFnZUZvcihrZXk6IFQpOiB2b2lkIHtcbiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5zdG9yYWdlcy5nZXQoa2V5KTtcblxuICAgIGlmIChzdG9yYWdlKSB7XG4gICAgICBzZXRWYWx1ZShzdG9yYWdlLCBudWxsKTtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcih2YWx1ZXM/OiByZWFkb25seSBUW10gfCBudWxsKSB7XG4gICAgdGhpcy52YWxzID0gbmV3IFdlYWtTZXQodmFsdWVzKTtcbiAgfVxuXG4gIGhhcyh2YWx1ZTogVCk6IGJvb2xlYW4ge1xuICAgIGdldFZhbHVlKHRoaXMuc3RvcmFnZUZvcih2YWx1ZSkpO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5oYXModmFsdWUpO1xuICB9XG5cbiAgYWRkKHZhbHVlOiBUKTogdGhpcyB7XG4gICAgLy8gQWRkIHRvIHZhbHMgZmlyc3QgdG8gZ2V0IGJldHRlciBlcnJvciBtZXNzYWdlXG4gICAgdGhpcy52YWxzLmFkZCh2YWx1ZSk7XG5cbiAgICB0aGlzLmRpcnR5U3RvcmFnZUZvcih2YWx1ZSk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGRlbGV0ZSh2YWx1ZTogVCk6IGJvb2xlYW4ge1xuICAgIHRoaXMuZGlydHlTdG9yYWdlRm9yKHZhbHVlKTtcblxuICAgIHJldHVybiB0aGlzLnZhbHMuZGVsZXRlKHZhbHVlKTtcbiAgfVxuXG4gIGdldCBbU3ltYm9sLnRvU3RyaW5nVGFnXSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnZhbHNbU3ltYm9sLnRvU3RyaW5nVGFnXTtcbiAgfVxufVxuXG4vLyBTbyBpbnN0YW5jZW9mIHdvcmtzXG5PYmplY3Quc2V0UHJvdG90eXBlT2YoVHJhY2tlZFdlYWtTZXQucHJvdG90eXBlLCBXZWFrU2V0LnByb3RvdHlwZSk7XG4iXX0=