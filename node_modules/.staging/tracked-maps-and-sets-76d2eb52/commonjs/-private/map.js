"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TrackedWeakMap = exports.TrackedMap = void 0;
const ember_tracked_storage_polyfill_1 = require("ember-tracked-storage-polyfill");
class TrackedMap {
    constructor(existing) {
        this.collection = (0, ember_tracked_storage_polyfill_1.createStorage)(null, () => false);
        this.storages = new Map();
        // TypeScript doesn't correctly resolve the overloads for calling the `Map`
        // constructor for the no-value constructor. This resolves that.
        this.vals = existing ? new Map(existing) : new Map();
    }
    readStorageFor(key) {
        const { storages } = this;
        let storage = storages.get(key);
        if (storage === undefined) {
            storage = (0, ember_tracked_storage_polyfill_1.createStorage)(null, () => false);
            storages.set(key, storage);
        }
        (0, ember_tracked_storage_polyfill_1.getValue)(storage);
    }
    dirtyStorageFor(key) {
        const storage = this.storages.get(key);
        if (storage) {
            (0, ember_tracked_storage_polyfill_1.setValue)(storage, null);
        }
    }
    // **** KEY GETTERS ****
    get(key) {
        // entangle the storage for the key
        this.readStorageFor(key);
        return this.vals.get(key);
    }
    has(key) {
        this.readStorageFor(key);
        return this.vals.has(key);
    }
    // **** ALL GETTERS ****
    entries() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.entries();
    }
    keys() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.keys();
    }
    values() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.values();
    }
    forEach(fn) {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        this.vals.forEach(fn);
    }
    get size() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals.size;
    }
    [Symbol.iterator]() {
        (0, ember_tracked_storage_polyfill_1.getValue)(this.collection);
        return this.vals[Symbol.iterator]();
    }
    get [Symbol.toStringTag]() {
        return this.vals[Symbol.toStringTag];
    }
    // **** KEY SETTERS ****
    set(key, value) {
        this.dirtyStorageFor(key);
        (0, ember_tracked_storage_polyfill_1.setValue)(this.collection, null);
        this.vals.set(key, value);
        return this;
    }
    delete(key) {
        this.dirtyStorageFor(key);
        (0, ember_tracked_storage_polyfill_1.setValue)(this.collection, null);
        return this.vals.delete(key);
    }
    // **** ALL SETTERS ****
    clear() {
        this.storages.forEach((s) => (0, ember_tracked_storage_polyfill_1.setValue)(s, null));
        (0, ember_tracked_storage_polyfill_1.setValue)(this.collection, null);
        this.vals.clear();
    }
}
exports.TrackedMap = TrackedMap;
// So instanceof works
Object.setPrototypeOf(TrackedMap.prototype, Map.prototype);
class TrackedWeakMap {
    constructor(existing) {
        this.storages = new WeakMap();
        // TypeScript doesn't correctly resolve the overloads for calling the `Map`
        // constructor for the no-value constructor. This resolves that.
        this.vals = existing ? new WeakMap(existing) : new WeakMap();
    }
    readStorageFor(key) {
        const { storages } = this;
        let storage = storages.get(key);
        if (storage === undefined) {
            storage = (0, ember_tracked_storage_polyfill_1.createStorage)(null, () => false);
            storages.set(key, storage);
        }
        (0, ember_tracked_storage_polyfill_1.getValue)(storage);
    }
    dirtyStorageFor(key) {
        const storage = this.storages.get(key);
        if (storage) {
            (0, ember_tracked_storage_polyfill_1.setValue)(storage, null);
        }
    }
    get(key) {
        this.readStorageFor(key);
        return this.vals.get(key);
    }
    has(key) {
        this.readStorageFor(key);
        return this.vals.has(key);
    }
    set(key, value) {
        this.dirtyStorageFor(key);
        this.vals.set(key, value);
        return this;
    }
    delete(key) {
        this.dirtyStorageFor(key);
        return this.vals.delete(key);
    }
    get [Symbol.toStringTag]() {
        return this.vals[Symbol.toStringTag];
    }
}
exports.TrackedWeakMap = TrackedWeakMap;
// So instanceof works
Object.setPrototypeOf(TrackedWeakMap.prototype, WeakMap.prototype);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjLy1wcml2YXRlL21hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtRkFLd0M7QUFFeEMsTUFBYSxVQUFVO0lBOEJyQixZQUNFLFFBSWE7UUFsQ1AsZUFBVSxHQUFHLElBQUEsOENBQWEsRUFBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFOUMsYUFBUSxHQUFpQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBa0N6RCwyRUFBMkU7UUFDM0UsZ0VBQWdFO1FBQ2hFLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBakNPLGNBQWMsQ0FBQyxHQUFNO1FBQzNCLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDMUIsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVoQyxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7WUFDekIsT0FBTyxHQUFHLElBQUEsOENBQWEsRUFBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDM0MsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDNUI7UUFFRCxJQUFBLHlDQUFRLEVBQUMsT0FBTyxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVPLGVBQWUsQ0FBQyxHQUFNO1FBQzVCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXZDLElBQUksT0FBTyxFQUFFO1lBQ1gsSUFBQSx5Q0FBUSxFQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN6QjtJQUNILENB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LENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRUQsR0FBRyxDQUFDLEdBQU07UUFDUixJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXpCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELEdBQUcsQ0FBQyxHQUFNLEVBQUUsS0FBUTtRQUNsQixJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTFCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUUxQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxNQUFNLENBQUMsR0FBTTtRQUNYLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFMUIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFDdEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN2QyxDQUFDO0NBQ0Y7QUFuRUQsd0NBbUVDO0FBRUQsc0JBQXNCO0FBQ3RCLE1BQU0sQ0FBQyxjQUFjLENBQUMsY0FBYyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBUcmFja2VkU3RvcmFnZSxcbiAgY3JlYXRlU3RvcmFnZSxcbiAgZ2V0VmFsdWUsXG4gIHNldFZhbHVlLFxufSBmcm9tICdlbWJlci10cmFja2VkLXN0b3JhZ2UtcG9seWZpbGwnO1xuXG5leHBvcnQgY2xhc3MgVHJhY2tlZE1hcDxLID0gdW5rbm93biwgViA9IHVua25vd24+IGltcGxlbWVudHMgTWFwPEssIFY+IHtcbiAgcHJpdmF0ZSBjb2xsZWN0aW9uID0gY3JlYXRlU3RvcmFnZShudWxsLCAoKSA9PiBmYWxzZSk7XG5cbiAgcHJpdmF0ZSBzdG9yYWdlczogTWFwPEssIFRyYWNrZWRTdG9yYWdlPG51bGw+PiA9IG5ldyBNYXAoKTtcblxuICBwcml2YXRlIHZhbHM6IE1hcDxLLCBWPjtcblxuICBwcml2YXRlIHJlYWRTdG9yYWdlRm9yKGtleTogSyk6IHZvaWQge1xuICAgIGNvbnN0IHsgc3RvcmFnZXMgfSA9IHRoaXM7XG4gICAgbGV0IHN0b3JhZ2UgPSBzdG9yYWdlcy5nZXQoa2V5KTtcblxuICAgIGlmIChzdG9yYWdlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHN0b3JhZ2UgPSBjcmVhdGVTdG9yYWdlKG51bGwsICgpID0+IGZhbHNlKTtcbiAgICAgIHN0b3JhZ2VzLnNldChrZXksIHN0b3JhZ2UpO1xuICAgIH1cblxuICAgIGdldFZhbHVlKHN0b3JhZ2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXJ0eVN0b3JhZ2VGb3Ioa2V5OiBLKTogdm9pZCB7XG4gICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuc3RvcmFnZXMuZ2V0KGtleSk7XG5cbiAgICBpZiAoc3RvcmFnZSkge1xuICAgICAgc2V0VmFsdWUoc3RvcmFnZSwgbnVsbCk7XG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IoKTtcbiAgY29uc3RydWN0b3IoZW50cmllczogcmVhZG9ubHkgKHJlYWRvbmx5IFtLLCBWXSlbXSB8IG51bGwpO1xuICBjb25zdHJ1Y3RvcihpdGVyYWJsZTogSXRlcmFibGU8cmVhZG9ubHkgW0ssIFZdPik7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGV4aXN0aW5nPzpcbiAgICAgIHwgcmVhZG9ubHkgKHJlYWRvbmx5IFtLLCBWXSlbXVxuICAgICAgfCBJdGVyYWJsZTxyZWFkb25seSBbSywgVl0+XG4gICAgICB8IG51bGxcbiAgICAgIHwgdW5kZWZpbmVkXG4gICkge1xuICAgIC8vIFR5cGVTY3JpcHQgZG9lc24ndCBjb3JyZWN0bHkgcmVzb2x2ZSB0aGUgb3ZlcmxvYWRzIGZvciBjYWxsaW5nIHRoZSBgTWFwYFxuICAgIC8vIGNvbnN0cnVjdG9yIGZvciB0aGUgbm8tdmFsdWUgY29uc3RydWN0b3IuIFRoaXMgcmVzb2x2ZXMgdGhhdC5cbiAgICB0aGlzLnZhbHMgPSBleGlzdGluZyA/IG5ldyBNYXAoZXhpc3RpbmcpIDogbmV3IE1hcCgpO1xuICB9XG5cbiAgLy8gKioqKiBLRVkgR0VUVEVSUyAqKioqXG4gIGdldChrZXk6IEspOiBWIHwgdW5kZWZpbmVkIHtcbiAgICAvLyBlbnRhbmdsZSB0aGUgc3RvcmFnZSBmb3IgdGhlIGtleVxuICAgIHRoaXMucmVhZFN0b3JhZ2VGb3Ioa2V5KTtcblxuICAgIHJldHVybiB0aGlzLnZhbHMuZ2V0KGtleSk7XG4gIH1cblxuICBoYXMoa2V5OiBLKTogYm9vbGVhbiB7XG4gICAgdGhpcy5yZWFkU3RvcmFnZUZvcihrZXkpO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5oYXMoa2V5KTtcbiAgfVxuXG4gIC8vICoqKiogQUxMIEdFVFRFUlMgKioqKlxuICBlbnRyaWVzKCk6IEl0ZXJhYmxlSXRlcmF0b3I8W0ssIFZdPiB7XG4gICAgZ2V0VmFsdWUodGhpcy5jb2xsZWN0aW9uKTtcblxuICAgIHJldHVybiB0aGlzLnZhbHMuZW50cmllcygpO1xuICB9XG5cbiAga2V5cygpOiBJdGVyYWJsZUl0ZXJhdG9yPEs+IHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5rZXlzKCk7XG4gIH1cblxuICB2YWx1ZXMoKTogSXRlcmFibGVJdGVyYXRvcjxWPiB7XG4gICAgZ2V0VmFsdWUodGhpcy5jb2xsZWN0aW9uKTtcblxuICAgIHJldHVybiB0aGlzLnZhbHMudmFsdWVzKCk7XG4gIH1cblxuICBmb3JFYWNoKGZuOiAodmFsdWU6IFYsIGtleTogSywgbWFwOiBNYXA8SywgVj4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgdGhpcy52YWxzLmZvckVhY2goZm4pO1xuICB9XG5cbiAgZ2V0IHNpemUoKTogbnVtYmVyIHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5zaXplO1xuICB9XG5cbiAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxbSywgVl0+IHtcbiAgICBnZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24pO1xuXG4gICAgcmV0dXJuIHRoaXMudmFsc1tTeW1ib2wuaXRlcmF0b3JdKCk7XG4gIH1cblxuICBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy52YWxzW1N5bWJvbC50b1N0cmluZ1RhZ107XG4gIH1cblxuICAvLyAqKioqIEtFWSBTRVRURVJTICoqKipcbiAgc2V0KGtleTogSywgdmFsdWU6IFYpOiB0aGlzIHtcbiAgICB0aGlzLmRpcnR5U3RvcmFnZUZvcihrZXkpO1xuICAgIHNldFZhbHVlKHRoaXMuY29sbGVjdGlvbiwgbnVsbCk7XG5cbiAgICB0aGlzLnZhbHMuc2V0KGtleSwgdmFsdWUpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBkZWxldGUoa2V5OiBLKTogYm9vbGVhbiB7XG4gICAgdGhpcy5kaXJ0eVN0b3JhZ2VGb3Ioa2V5KTtcbiAgICBzZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24sIG51bGwpO1xuXG4gICAgcmV0dXJuIHRoaXMudmFscy5kZWxldGUoa2V5KTtcbiAgfVxuXG4gIC8vICoqKiogQUxMIFNFVFRFUlMgKioqKlxuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JhZ2VzLmZvckVhY2goKHMpID0+IHNldFZhbHVlKHMsIG51bGwpKTtcbiAgICBzZXRWYWx1ZSh0aGlzLmNvbGxlY3Rpb24sIG51bGwpO1xuXG4gICAgdGhpcy52YWxzLmNsZWFyKCk7XG4gIH1cbn1cblxuLy8gU28gaW5zdGFuY2VvZiB3b3Jrc1xuT2JqZWN0LnNldFByb3RvdHlwZU9mKFRyYWNrZWRNYXAucHJvdG90eXBlLCBNYXAucHJvdG90eXBlKTtcblxuZXhwb3J0IGNsYXNzIFRyYWNrZWRXZWFrTWFwPEsgZXh0ZW5kcyBvYmplY3QgPSBvYmplY3QsIFYgPSB1bmtub3duPlxuICBpbXBsZW1lbnRzIFdlYWtNYXA8SywgVj5cbntcbiAgcHJpdmF0ZSBzdG9yYWdlczogV2Vha01hcDxLLCBUcmFja2VkU3RvcmFnZTxudWxsPj4gPSBuZXcgV2Vha01hcCgpO1xuXG4gIHByaXZhdGUgdmFsczogV2Vha01hcDxLLCBWPjtcblxuICBwcml2YXRlIHJlYWRTdG9yYWdlRm9yKGtleTogSyk6IHZvaWQge1xuICAgIGNvbnN0IHsgc3RvcmFnZXMgfSA9IHRoaXM7XG4gICAgbGV0IHN0b3JhZ2UgPSBzdG9yYWdlcy5nZXQoa2V5KTtcblxuICAgIGlmIChzdG9yYWdlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHN0b3JhZ2UgPSBjcmVhdGVTdG9yYWdlKG51bGwsICgpID0+IGZhbHNlKTtcbiAgICAgIHN0b3JhZ2VzLnNldChrZXksIHN0b3JhZ2UpO1xuICAgIH1cblxuICAgIGdldFZhbHVlKHN0b3JhZ2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXJ0eVN0b3JhZ2VGb3Ioa2V5OiBLKTogdm9pZCB7XG4gICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuc3RvcmFnZXMuZ2V0KGtleSk7XG5cbiAgICBpZiAoc3RvcmFnZSkge1xuICAgICAgc2V0VmFsdWUoc3RvcmFnZSwgbnVsbCk7XG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IoKTtcbiAgY29uc3RydWN0b3IoaXRlcmFibGU6IEl0ZXJhYmxlPHJlYWRvbmx5IFtLLCBWXT4pO1xuICBjb25zdHJ1Y3RvcihlbnRyaWVzOiByZWFkb25seSBbSywgVl1bXSB8IG51bGwpO1xuICBjb25zdHJ1Y3RvcihcbiAgICBleGlzdGluZz86IHJlYWRvbmx5IFtLLCBWXVtdIHwgSXRlcmFibGU8cmVhZG9ubHkgW0ssIFZdPiB8IG51bGwgfCB1bmRlZmluZWRcbiAgKSB7XG4gICAgLy8gVHlwZVNjcmlwdCBkb2Vzbid0IGNvcnJlY3RseSByZXNvbHZlIHRoZSBvdmVybG9hZHMgZm9yIGNhbGxpbmcgdGhlIGBNYXBgXG4gICAgLy8gY29uc3RydWN0b3IgZm9yIHRoZSBuby12YWx1ZSBjb25zdHJ1Y3Rvci4gVGhpcyByZXNvbHZlcyB0aGF0LlxuICAgIHRoaXMudmFscyA9IGV4aXN0aW5nID8gbmV3IFdlYWtNYXAoZXhpc3RpbmcpIDogbmV3IFdlYWtNYXAoKTtcbiAgfVxuXG4gIGdldChrZXk6IEspOiBWIHwgdW5kZWZpbmVkIHtcbiAgICB0aGlzLnJlYWRTdG9yYWdlRm9yKGtleSk7XG5cbiAgICByZXR1cm4gdGhpcy52YWxzLmdldChrZXkpO1xuICB9XG5cbiAgaGFzKGtleTogSyk6IGJvb2xlYW4ge1xuICAgIHRoaXMucmVhZFN0b3JhZ2VGb3Ioa2V5KTtcblxuICAgIHJldHVybiB0aGlzLnZhbHMuaGFzKGtleSk7XG4gIH1cblxuICBzZXQoa2V5OiBLLCB2YWx1ZTogVik6IHRoaXMge1xuICAgIHRoaXMuZGlydHlTdG9yYWdlRm9yKGtleSk7XG5cbiAgICB0aGlzLnZhbHMuc2V0KGtleSwgdmFsdWUpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBkZWxldGUoa2V5OiBLKTogYm9vbGVhbiB7XG4gICAgdGhpcy5kaXJ0eVN0b3JhZ2VGb3Ioa2V5KTtcblxuICAgIHJldHVybiB0aGlzLnZhbHMuZGVsZXRlKGtleSk7XG4gIH1cblxuICBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy52YWxzW1N5bWJvbC50b1N0cmluZ1RhZ107XG4gIH1cbn1cblxuLy8gU28gaW5zdGFuY2VvZiB3b3Jrc1xuT2JqZWN0LnNldFByb3RvdHlwZU9mKFRyYWNrZWRXZWFrTWFwLnByb3RvdHlwZSwgV2Vha01hcC5wcm90b3R5cGUpO1xuIl19